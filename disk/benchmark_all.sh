#!/bin/bash

# ë¸”ë¡ í¬ê¸°ë³„ ì„±ëŠ¥ ìë™ ë²¤ì¹˜ë§ˆí¬ ìŠ¤í¬ë¦½íŠ¸

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          ìë™ ë¸”ë¡ í¬ê¸° ë²¤ì¹˜ë§ˆí¬ ìŠ¤í¬ë¦½íŠ¸                     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# í…ŒìŠ¤íŠ¸í•  ë¸”ë¡ í¬ê¸° ë°°ì—´
BLOCK_SIZES=(2048 4096 8192 16384 32768)

# ê²°ê³¼ íŒŒì¼ ì´ˆê¸°í™”
RESULT_FILE="benchmark_results.txt"
echo "ë¸”ë¡ í¬ê¸° ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼" > $RESULT_FILE
echo "í…ŒìŠ¤íŠ¸ ì‹œê°„: $(date)" >> $RESULT_FILE
echo "========================================" >> $RESULT_FILE
echo "" >> $RESULT_FILE

# ì›ë³¸ í—¤ë” íŒŒì¼ ë°±ì—…
cp block_reader.h block_reader.h.backup

echo ""
echo "ğŸ“‹ í…ŒìŠ¤íŠ¸ ë¸”ë¡ í¬ê¸°: ${BLOCK_SIZES[@]}"
echo ""

for size in "${BLOCK_SIZES[@]}"
do
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  ğŸ” í…ŒìŠ¤íŠ¸ ë¸”ë¡ í¬ê¸°: ${size} bytes ($((size / 1024)) KB)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # block_reader.hì˜ BLOCK_SIZE ìˆ˜ì •
    sed -i "s/#define BLOCK_SIZE [0-9]\+/#define BLOCK_SIZE $size/" block_reader.h
    
    # ì¬ì»´íŒŒì¼
    echo "ğŸ“¦ ì»´íŒŒì¼ ì¤‘..."
    make clean > /dev/null 2>&1
    make test_block_size > /dev/null 2>&1
    
    if [ $? -ne 0 ]; then
        echo "âŒ ì»´íŒŒì¼ ì‹¤íŒ¨!"
        continue
    fi
    
    echo "âœ… ì»´íŒŒì¼ ì™„ë£Œ"
    echo ""
    
    # í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    echo "ğŸš€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
    ./test_block_size | tee -a $RESULT_FILE
    
    echo "" >> $RESULT_FILE
    echo "========================================" >> $RESULT_FILE
    echo "" >> $RESULT_FILE
    
    # ì ì‹œ ëŒ€ê¸° (ì‹œìŠ¤í…œ ì•ˆì •í™”)
    sleep 2
done

# ì›ë³¸ í—¤ë” íŒŒì¼ ë³µì›
mv block_reader.h.backup block_reader.h

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  âœ… ëª¨ë“  ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“Š ê²°ê³¼ íŒŒì¼: $RESULT_FILE"
echo "ğŸ“‹ ê²°ê³¼ í™•ì¸: cat $RESULT_FILE"
echo ""

# ìš”ì•½ í…Œì´ë¸” ìƒì„±
echo ""
echo "ğŸ“Š ì„±ëŠ¥ ìš”ì•½ í…Œì´ë¸”:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
printf "%-12s %-15s %-15s %-15s\n" "Block Size" "Customer I/O" "Orders I/O" "Customer Speed"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
grep -A2 "Customer íŒŒì¼" $RESULT_FILE | grep "ì´ I/O íšŸìˆ˜" | awk '{print $3}' > /tmp/cust_io.txt
grep -A2 "Orders íŒŒì¼" $RESULT_FILE | grep "ì´ I/O íšŸìˆ˜" | awk '{print $3}' > /tmp/ord_io.txt
grep -A2 "Customer íŒŒì¼" $RESULT_FILE | grep "ì´ˆë‹¹ ì²˜ë¦¬" | awk '{print $3}' > /tmp/cust_speed.txt

idx=0
for size in "${BLOCK_SIZES[@]}"
do
    cust_io=$(sed -n "$((idx+1))p" /tmp/cust_io.txt)
    ord_io=$(sed -n "$((idx+1))p" /tmp/ord_io.txt)
    cust_speed=$(sed -n "$((idx+1))p" /tmp/cust_speed.txt)
    printf "%-12s %-15s %-15s %-15s\n" "$((size/1024))KB" "$cust_io" "$ord_io" "$cust_speed"
    idx=$((idx+1))
done
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
